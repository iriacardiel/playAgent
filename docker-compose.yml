# docker-compose.yml

services:
  neo4j:
    image: neo4j:5.23-community
    container_name: neo4j
    restart: unless-stopped
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:${NEO4J_HTTP_PORT:-7474}"   # Browser (e.g. 7474:7474)
      - "${NEO4J_URI_PORT:-7687}:${NEO4J_URI_PORT:-7687}"     # Bolt (e.g. 7687:7687)
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-test1234}
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data

  neodash:
    image: neo4jlabs/neodash:latest
    container_name: neodash
    restart: unless-stopped
    ports:
      - "${NEODASH_HTTP_PORT:-5005}:${NEODASH_HTTP_PORT:-5005}"   # Browser (e.g. 5005:5005)
    env_file:              
      - .env
    environment:
      NODE_ENV: development
    depends_on:
      - neo4j

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    ports: ["${OLLAMA_PORT:-11434}:${OLLAMA_PORT:-11434}"]
    env_file:
      - .env
    environment:
      OLLAMA_KEEP_ALIVE: "24h"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ./ollama-custom/.ollama:/root/.ollama

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: agent-backend-i:latest  # tag the result so it's easy to reference/save
    container_name: agent-backend-c
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-2024}:${BACKEND_PORT:-2024}"
      - "${LANGGRAPH_DEV_PORT:-2924}:${LANGGRAPH_DEV_PORT:-2924}"
    env_file:
      - .env
    environment:
      PORT: "${BACKEND_PORT:-2024}"
      LANGGRAPH_DEV_PORT: "${LANGGRAPH_DEV_PORT:-2924}"
    gpus: all # UNCOMMENT if you have nvidia-docker set up
    depends_on:
      - ollama
      - neo4j
    volumes:
      - ./backend/src:/app/src
      - ./backend/langgraph.json:/app/langgraph.json

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        LANGGRAPH_API_URL: http://backend:${LANGGRAPH_DEV_PORT:-2924}  # or whatever you want at build time
        BUILDKIT_INLINE_CACHE: 1
    image: agent-frontend-i:latest
    container_name: agent-frontend-c
    restart: unless-stopped
    ports: ["${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"]
    env_file:
      - .env
    environment:
      NODE_ENV: development
      PORT: "${FRONTEND_PORT:-3000}"
      NEXT_PUBLIC_API_URL: "http://localhost:${BACKEND_PORT:-2024}"
      LANGGRAPH_API_URL: "http://backend:${LANGGRAPH_DEV_PORT:-2924}"
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    command: pnpm dev

volumes:
  neo4j_data: