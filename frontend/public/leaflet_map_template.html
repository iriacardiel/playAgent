<head>
  <link rel="stylesheet" href="/leaflet/leaflet.css" crossorigin=""/>
  <style>
    html, body, #map { height: 100%; margin: 0; }  /* critical: gives the map a height */
    .popup-name { font-weight: 600; margin-bottom: 4px; }
    .legend {
      position: absolute; z-index: 1000; bottom: 16px; left: 16px;
      background: white; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .legend .badge { display:inline-block; width:20px; height:20px; margin-right:6px; border-radius:3px; }
    .legend img { width: 20px; height: 20px; vertical-align: middle; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="/leaflet/leaflet.js" crossorigin=""></script>
  <script>
    const DEFAULT_CENTER = [40.4168, -3.7038];
    const DEFAULT_ZOOM = 12;

    // ⬇️ Read from query param or fallback to same origin
    const params = new URLSearchParams(location.search);
    const backend = params.get('backend') || location.origin;

    const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

    map.createPane('edges');  map.getPane('edges').style.zIndex = 390;
    map.createPane('nodes');  map.getPane('nodes').style.zIndex = 400;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Custom icons for each label type
    const icons = {
      Person: L.icon({
        iconUrl: '/person.png', // Path to the person icon
        iconSize: [32, 32],            // Adjust size as needed
        iconAnchor: [16, 32],          // Anchor point for the icon
        popupAnchor: [0, -32]          // Popup position relative to the icon
      }),
      Company: L.icon({
        iconUrl: '/company.png', // Path to the company icon
        iconSize: [32, 32],             // Adjust size as needed
        iconAnchor: [16, 32],           // Anchor point for the icon
        popupAnchor: [0, -32]           // Popup position relative to the icon
      })
    };

    // Function to set node marker style based on the label
    function nodeMarker(feature, latlng) {
      const labels = (feature.properties?.labels) || [];
      const primary = labels[0] || 'Other'; // Default to 'Other' if no label exists

      // Use the appropriate icon for the label, default to 'Person' if label doesn't match
      const icon = icons[primary] || icons['Person'];

      return L.marker(latlng, { icon: icon, pane: 'nodes' });
    }

    // Style for edges
    function edgeStyle() {
      return { color: '#7a7a7a', weight: 1.5, opacity: 0.7, pane: 'edges' };
    }

    const nodesLayer = L.geoJSON(null, {
      pointToLayer: nodeMarker,
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const name = p.name || 'Unknown';
        layer.bindPopup(`<div class="popup-name">${name}</div>${(p.labels || []).join(', ')}`);
        layer.bindTooltip(name, { direction: 'top', offset: [0, -8] });
      }
    });

    const edgesLayer = L.geoJSON(null, {
      style: edgeStyle,
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        const t = p.rel_type || 'RELATED';
        layer.bindTooltip(t);
        layer.bindPopup(`<b>${p.src_name || p.src_id}</b> —[${t}]→ <b>${p.dst_name || p.dst_id}</b>`);
      }
    });

    // Updated legend to use images instead of colors
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div><img src="/person.png" alt="Person Icon"> Person</div>
        <div><img src="/company.png" alt="Company Icon"> Company</div>
      `;
      return div;
    };
    legend.addTo(map);

    async function refreshData() {
      console.log("🔄 Refreshing map data at", new Date().toLocaleTimeString());

      try {
        const res = await fetch(`${backend}/api/map_features`, { method: 'POST', cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load map data');
        const { nodes, edges } = await res.json();

        // Clear old layers
        nodesLayer.clearLayers();
        edgesLayer.clearLayers();

        if (edges?.type === 'FeatureCollection') edgesLayer.addData(edges).addTo(map);
        if (nodes?.type === 'FeatureCollection') nodesLayer.addData(nodes).addTo(map);
      } catch (err) {
        console.error('Refresh error:', err);
      }
    }

    // initial load
    refreshData();

    // repeat every 5s
    setInterval(refreshData, 1000);

  </script>
</body>
